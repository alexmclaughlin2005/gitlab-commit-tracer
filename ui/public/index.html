<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitLab Commit Tracer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            color: #2c3e50;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .header-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-dropdown {
            position: relative;
            display: inline-block;
        }

        .nav-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 1em;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .nav-dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            padding-top: 8px;
            background: transparent;
            min-width: 200px;
            z-index: 1000;
        }

        .nav-dropdown-content::before {
            content: '';
            display: block;
            height: 8px;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
        }

        .nav-dropdown-menu {
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 8px;
            overflow: hidden;
        }

        .nav-dropdown:hover .nav-dropdown-content {
            display: block;
        }

        .nav-dropdown-content a {
            color: #2c3e50;
            padding: 12px 20px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
            border-bottom: 1px solid #f0f0f0;
        }

        .nav-dropdown-content a:last-child {
            border-bottom: none;
        }

        .nav-dropdown-content a:hover {
            background: #f8f9fa;
            padding-left: 25px;
        }

        .nav-icon {
            font-size: 1.2em;
        }

        .status-banner {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.connected {
            background: #27ae60;
            box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.2);
        }

        .status-indicator.disconnected {
            background: #e74c3c;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.2);
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .controls h2 {
            margin-bottom: 15px;
            color: #667eea;
        }

        .control-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        input, select, button {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        input, select {
            flex: 1;
            min-width: 200px;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        button:hover {
            background: #764ba2;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        .results {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .chain-card {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 6px;
        }

        .chain-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .commit-info h3 {
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .commit-meta {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .chain-stats {
            text-align: right;
            font-size: 0.9em;
        }

        .stat-badge {
            display: inline-block;
            background: white;
            padding: 4px 10px;
            border-radius: 12px;
            margin-left: 5px;
            font-weight: 500;
        }

        .cache-badge {
            display: inline-block;
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 10px;
            border-radius: 12px;
            margin-left: 5px;
            font-weight: 500;
            font-size: 0.85em;
        }

        .chain-flow {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 0;
            border-top: 1px solid #e0e0e0;
            border-bottom: 1px solid #e0e0e0;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .flow-item {
            background: white;
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid #ddd;
        }

        .flow-item strong {
            color: #667eea;
        }

        .arrow {
            color: #bbb;
            font-size: 1.5em;
        }

        .chain-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .detail-section {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }

        .detail-section h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 0.95em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-item {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .label-tag {
            display: inline-block;
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.85em;
            margin-right: 5px;
        }

        .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 10px 15px;
            margin-top: 10px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .error {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 10px 15px;
            margin-top: 10px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 10px 15px;
            margin-top: 10px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        a {
            color: #667eea;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        .updates-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }

        .updates-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .updates-header h4 {
            color: #667eea;
            font-size: 1.1em;
        }

        .generate-updates-btn {
            background: #28a745;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .generate-updates-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .generate-updates-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        .update-box {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .update-box.technical {
            border-left: 4px solid #667eea;
        }

        .update-box.business {
            border-left: 4px solid #28a745;
        }

        .update-box-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-weight: 600;
            color: #2c3e50;
        }

        .update-box-header .icon {
            font-size: 1.3em;
        }

        .update-box-content {
            line-height: 1.6;
            color: #2c3e50;
        }

        .update-meta {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e0e0e0;
            font-size: 0.85em;
            color: #7f8c8d;
        }

        .copy-btn {
            background: #f0f0f0;
            color: #2c3e50;
            padding: 4px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            margin-left: 10px;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: #e0e0e0;
        }

        .updates-loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }

        .updates-loading .spinner {
            width: 30px;
            height: 30px;
            margin: 0 auto 10px;
        }

        /* MR List Styles */
        .mr-list-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .mr-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .mr-list-header h2 {
            color: #667eea;
            margin: 0;
        }

        .mr-filter-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-btn-group {
            display: flex;
            gap: 5px;
            background: #f8f9fa;
            padding: 4px;
            border-radius: 6px;
        }

        .filter-btn-group button {
            padding: 6px 12px;
            font-size: 0.85em;
            background: transparent;
            border: none;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .filter-btn-group button.active {
            background: #667eea;
            color: white;
        }

        .mr-card {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .mr-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .mr-card.merged {
            border-left-color: #9b59b6;
        }

        .mr-card.closed {
            border-left-color: #e74c3c;
        }

        .mr-card.opened {
            border-left-color: #28a745;
        }

        .mr-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .mr-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .mr-meta {
            font-size: 0.85em;
            color: #7f8c8d;
        }

        .mr-meta a {
            color: #667eea;
            text-decoration: none;
        }

        .mr-meta a:hover {
            text-decoration: underline;
        }

        .mr-state-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .mr-state-badge.merged {
            background: #e8d6f1;
            color: #6f42c1;
        }

        .mr-state-badge.opened {
            background: #d4edda;
            color: #155724;
        }

        .mr-state-badge.closed {
            background: #f8d7da;
            color: #721c24;
        }

        .mr-stats {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            font-size: 0.85em;
            color: #7f8c8d;
        }

        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .pagination-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .pagination-buttons button {
            padding: 8px 16px;
            background: white;
            border: 1px solid #ddd;
            color: #2c3e50;
            font-size: 0.9em;
        }

        .pagination-buttons button:hover:not(:disabled) {
            background: #f8f9fa;
            transform: none;
        }

        .pagination-buttons button:disabled {
            background: #f8f9fa;
            color: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        .pagination-info {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .page-size-select {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .page-size-select select {
            padding: 6px 10px;
            min-width: auto;
            width: auto;
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .collapsible-content.expanded {
            max-height: 10000px;
            transition: max-height 0.5s ease-in;
        }

        .toggle-btn {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 1.2em;
            padding: 0;
            margin-left: 10px;
            transition: transform 0.3s;
        }

        .toggle-btn.expanded {
            transform: rotate(180deg);
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-nav">
                <div>
                    <h1>üîç GitLab Commit Tracer</h1>
                    <p>Trace commits through their complete development lifecycle</p>
                </div>
                <div class="nav-dropdown">
                    <button class="nav-btn">
                        <span>üìë Browse History</span>
                        <span>‚ñº</span>
                    </button>
                    <div class="nav-dropdown-content">
                        <div class="nav-dropdown-menu">
                            <a href="index.html">
                                <span class="nav-icon">üè†</span>
                                <span>Home</span>
                            </a>
                            <a href="teams.html">
                                <span class="nav-icon">üë•</span>
                                <span>Teams View</span>
                            </a>
                            <a href="epics.html">
                                <span class="nav-icon">üìä</span>
                                <span>Epics View</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="status-banner" id="statusBanner">
            <div>
                <span class="status-indicator disconnected" id="statusIndicator"></span>
                <span id="statusText">Checking connection...</span>
            </div>
            <div id="projectInfo" style="font-size: 0.9em; color: #7f8c8d;"></div>
        </div>

        <!-- Monitoring Section -->
        <div class="controls" style="margin-top: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; color: white;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin: 0; color: white;">üîî Automatic Monitoring</h2>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="startMonitoring()" id="startMonitorBtn" style="background: #2ecc71; border: none; color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                        ‚ñ∂Ô∏è Start
                    </button>
                    <button onclick="stopMonitoring()" id="stopMonitorBtn" style="background: #e74c3c; border: none; color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                        ‚è∏Ô∏è Stop
                    </button>
                    <button onclick="pollNow()" id="pollNowBtn" style="background: #3498db; border: none; color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                        üîç Poll Now
                    </button>
                    <button onclick="showRecentCommits()" id="showRecentBtn" style="background: #f39c12; border: none; color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                        üìã Show Recent Commits
                    </button>
                    <button onclick="refreshMonitorStatus()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                        üîÑ Refresh
                    </button>
                </div>
            </div>
            <div id="monitorStatus" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 6px; font-size: 0.9em;">
                <p style="margin: 0;">Loading monitor status...</p>
            </div>
        </div>

        <!-- Monitored Commits Feed -->
        <div class="controls" style="margin-top: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin: 0;">üìã Monitored Commits</h2>
                <button onclick="refreshMonitoredCommits()" style="background: #667eea; border: none; color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                    üîÑ Refresh Feed
                </button>
            </div>
            <div id="monitoredCommits" style="min-height: 100px;">
                <p style="text-align: center; color: #7f8c8d;">
                    No monitored commits yet. Start monitoring to see new commits automatically.
                </p>
            </div>
        </div>

        <div class="controls">
            <h2>Manual Trace</h2>

            <div class="control-group">
                <input type="text" id="commitShaInput" placeholder="Enter commit SHA (e.g., abc123...)" />
                <label style="margin-left: 10px; font-size: 14px;">
                    <input type="checkbox" id="forceRefreshCheck" /> Force Refresh
                </label>
                <button onclick="traceSingleCommit()" id="traceSingleBtn">Trace Single Commit</button>
            </div>

            <div class="control-group">
                <input type="number" id="recentCountInput" value="5" min="1" max="20" />
                <input type="text" id="branchInput" placeholder="Branch (optional, e.g., main)" />
                <button onclick="traceRecentCommits()" id="traceRecentBtn">Trace Recent Commits</button>
            </div>
        </div>

        <!-- Recent Commits from Database Section -->
        <div class="mr-list-section">
            <div class="mr-list-header">
                <div style="display: flex; align-items: center;">
                    <h2>üì¶ Recent Commits</h2>
                    <button class="toggle-btn expanded" onclick="toggleCommitsSection(this)" title="Expand/Collapse">
                        ‚ñº
                    </button>
                </div>
                <div class="mr-filter-controls">
                    <button onclick="refreshCommitsList()" style="background: #667eea; border: none; color: white; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                        üîÑ Refresh
                    </button>
                </div>
            </div>

            <div class="collapsible-content expanded" id="commitsCollapsibleContent">
                <div id="commitsListContent">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading recent commits from database...</p>
                    </div>
                </div>

                <div class="pagination-controls" id="commitsPaginationControls" style="display: none;">
                    <div class="page-size-select">
                        <label for="commitsPageSize">Items per page:</label>
                        <select id="commitsPageSize" onchange="changeCommitsPageSize()">
                            <option value="10" selected>10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                        </select>
                    </div>

                    <div class="pagination-info" id="commitsPaginationInfo">
                        Page 1 of 1
                    </div>

                    <div class="pagination-buttons">
                        <button onclick="goToCommitsPage('first')" id="commitsFirstBtn">‚èÆ First</button>
                        <button onclick="goToCommitsPage('prev')" id="commitsPrevBtn">‚Üê Previous</button>
                        <button onclick="goToCommitsPage('next')" id="commitsNextBtn">Next ‚Üí</button>
                        <button onclick="goToCommitsPage('last')" id="commitsLastBtn">Last ‚è≠</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Merge Requests List Section -->
        <div class="mr-list-section">
            <div class="mr-list-header">
                <div style="display: flex; align-items: center;">
                    <h2>üîÄ Merge Requests</h2>
                    <button class="toggle-btn" onclick="toggleMRSection(this)" title="Expand/Collapse">
                        ‚ñº
                    </button>
                </div>
                <div class="mr-filter-controls">
                    <div class="filter-btn-group">
                        <button class="active" onclick="filterMRs('all')">All</button>
                        <button onclick="filterMRs('opened')">Opened</button>
                        <button onclick="filterMRs('merged')">Merged</button>
                        <button onclick="filterMRs('closed')">Closed</button>
                    </div>
                    <button onclick="syncMRsFromGitLab()" style="background: #28a745; border: none; color: white; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                        üîÑ Sync from GitLab
                    </button>
                    <button onclick="refreshMRList()" style="background: #667eea; border: none; color: white; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                        üîÑ Refresh
                    </button>
                </div>
            </div>

            <div class="collapsible-content" id="mrCollapsibleContent">
                <div id="mrListContent">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading merge requests...</p>
                    </div>
                </div>

                <div class="pagination-controls" id="mrPaginationControls" style="display: none;">
                <div class="page-size-select">
                    <label for="mrPageSize">Items per page:</label>
                    <select id="mrPageSize" onchange="changeMRPageSize()">
                        <option value="10">10</option>
                        <option value="20" selected>20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>

                <div class="pagination-info" id="mrPaginationInfo">
                    Page 1 of 1
                </div>

                <div class="pagination-buttons">
                    <button onclick="goToMRPage('first')" id="mrFirstBtn">‚èÆ First</button>
                    <button onclick="goToMRPage('prev')" id="mrPrevBtn">‚Üê Previous</button>
                    <button onclick="goToMRPage('next')" id="mrNextBtn">Next ‚Üí</button>
                    <button onclick="goToMRPage('last')" id="mrLastBtn">Last ‚è≠</button>
                </div>
                </div>
            </div>
        </div>

        <div class="results" id="results">
            <p style="text-align: center; color: #7f8c8d;">
                Enter a commit SHA or trace recent commits to get started
            </p>
        </div>
    </div>

    <script>
        // Environment-aware API URL
        const API_BASE = window.location.hostname === 'localhost'
            ? 'http://localhost:3005/api'
            : 'https://web-production-7418.up.railway.app/api';

        console.log('Using API Base URL:', API_BASE);
        let currentTraceData = null;

        // Check status on load
        window.addEventListener('load', checkStatus);

        async function checkStatus() {
            try {
                const response = await fetch(`${API_BASE}/status`);
                const data = await response.json();

                const indicator = document.getElementById('statusIndicator');
                const statusText = document.getElementById('statusText');
                const projectInfo = document.getElementById('projectInfo');

                if (data.gitlabConnected) {
                    indicator.className = 'status-indicator connected';
                    statusText.textContent = 'Connected to GitLab';
                    projectInfo.textContent = `${data.gitlabUrl} ‚Ä¢ Project: ${data.projectId}`;
                } else {
                    indicator.className = 'status-indicator disconnected';
                    statusText.textContent = 'Not connected to GitLab';
                    projectInfo.textContent = data.error || 'Check your configuration';
                }
            } catch (error) {
                console.error('Failed to check status:', error);
                document.getElementById('statusText').textContent = 'Server not responding';
            }
        }

        async function traceSingleCommit() {
            const sha = document.getElementById('commitShaInput').value.trim();
            if (!sha) {
                alert('Please enter a commit SHA');
                return;
            }

            const forceRefresh = document.getElementById('forceRefreshCheck').checked;
            setLoading(true);

            try {
                const response = await fetch(`${API_BASE}/trace/commit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sha, forceRefresh })
                });

                if (!response.ok) {
                    throw new Error(await response.text());
                }

                const chain = await response.json();
                currentTraceData = { chains: [chain], summary: null };
                displayResults([chain]);
            } catch (error) {
                displayError(error.message);
            } finally {
                setLoading(false);
            }
        }

        async function traceRecentCommits() {
            const count = parseInt(document.getElementById('recentCountInput').value);
            const branch = document.getElementById('branchInput').value.trim() || undefined;

            setLoading(true);

            try {
                const response = await fetch(`${API_BASE}/trace/recent`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ count, branch })
                });

                if (!response.ok) {
                    throw new Error(await response.text());
                }

                const result = await response.json();
                currentTraceData = result;
                displayResults(result.chains, result.summary);
            } catch (error) {
                displayError(error.message);
            } finally {
                setLoading(false);
            }
        }

        function setLoading(loading) {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(btn => btn.disabled = loading);

            if (loading) {
                document.getElementById('results').innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Tracing commits...</p>
                    </div>
                `;
            }
        }

        function displayResults(chains, summary = null) {
            const resultsDiv = document.getElementById('results');
            let html = '';

            if (summary) {
                html += `
                    <div class="success">
                        <strong>Batch Trace Complete</strong><br>
                        Total: ${summary.totalCommits} commits ‚Ä¢
                        Success: ${summary.successCount} ‚Ä¢
                        Failed: ${summary.failureCount} ‚Ä¢
                        Total API calls: ${summary.totalApiCalls} ‚Ä¢
                        Duration: ${summary.totalDurationMs}ms
                    </div>
                `;
            }

            chains.forEach(chain => {
                html += renderChain(chain);
            });

            resultsDiv.innerHTML = html || '<p>No results</p>';
        }

        function renderChain(chain) {
            const commit = chain.commit;
            const metadata = chain.metadata;
            const fromCache = chain._fromCache || false;
            const cachedAt = chain._cachedAt ? new Date(chain._cachedAt) : null;

            let html = `
                <div class="chain-card">
                    <div class="chain-header">
                        <div class="commit-info">
                            <h3>${escapeHtml(commit.title)}</h3>
                            <div class="commit-meta">
                                <code>${commit.short_id}</code> ‚Ä¢
                                ${commit.author_name} ‚Ä¢
                                ${new Date(commit.created_at).toLocaleString()}
                                ${fromCache ? `<span class="cache-badge">üíæ From Cache (${cachedAt ? cachedAt.toLocaleString() : 'cached'})</span>` : ''}
                            </div>
                        </div>
                        <div class="chain-stats">
                            <div>
                                <span class="stat-badge">‚è±Ô∏è ${metadata.durationMs}ms</span>
                                <span class="stat-badge">üîó ${metadata.apiCallCount} API calls</span>
                            </div>
                            <div style="margin-top: 5px;">
                                <span class="stat-badge">${metadata.isComplete ? '‚úÖ Complete' : '‚ö†Ô∏è Partial'}</span>
                            </div>
                        </div>
                    </div>

                    <div class="chain-flow">
                        <div class="flow-item">
                            <strong>Commit</strong><br>
                            <code>${commit.short_id}</code>
                        </div>
                        <span class="arrow">‚Üí</span>
                        <div class="flow-item">
                            <strong>MRs</strong><br>
                            ${chain.mergeRequests.length} found
                        </div>
                        <span class="arrow">‚Üí</span>
                        <div class="flow-item">
                            <strong>Issues</strong><br>
                            ${chain.issues.length} found
                        </div>
                        <span class="arrow">‚Üí</span>
                        <div class="flow-item">
                            <strong>Epics</strong><br>
                            ${chain.epics.length} found
                        </div>
                    </div>

                    <div class="chain-details">
                        ${chain.mergeRequests.length > 0 ? renderMRs(chain.mergeRequests) : ''}
                        ${chain.issues.length > 0 ? renderIssues(chain.issues) : ''}
                        ${chain.epics.length > 0 ? renderEpics(chain.epics) : ''}
                    </div>

                    ${metadata.warnings.length > 0 ? `
                        <div class="warning">
                            <strong>Warnings:</strong><br>
                            ${metadata.warnings.map(w => `‚Ä¢ ${escapeHtml(w)}`).join('<br>')}
                        </div>
                    ` : ''}

                    <div class="updates-section" id="updates-${commit.id}">
                        <div class="updates-header">
                            <h4>üì¢ Stakeholder Updates</h4>
                            <button class="generate-updates-btn" onclick="generateUpdates('${commit.id}')">
                                Generate Updates
                            </button>
                        </div>
                        <div id="updates-content-${commit.id}">
                            <p style="text-align: center; color: #7f8c8d; font-size: 0.9em;">
                                Click "Generate Updates" to create technical and business updates for this commit
                            </p>
                        </div>
                    </div>
                </div>
            `;

            return html;
        }

        function renderMRs(mrLinks) {
            return `
                <div class="detail-section">
                    <h4>Merge Requests (${mrLinks.length})</h4>
                    ${mrLinks.map(link => {
                        const mr = link.mergeRequest;
                        return `
                            <div class="detail-item">
                                <div><strong>!${mr.iid}:</strong> <a href="${mr.web_url}" target="_blank">${escapeHtml(mr.title)}</a></div>
                                <div style="font-size: 0.85em; color: #7f8c8d;">
                                    ${mr.state} ‚Ä¢ Closes ${link.closesIssues.length} issue(s)
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderIssues(issueLinks) {
            return `
                <div class="detail-section">
                    <h4>Issues (${issueLinks.length})</h4>
                    ${issueLinks.map(link => {
                        const issue = link.issue;
                        return `
                            <div class="detail-item">
                                <div><strong>#${issue.iid}:</strong> <a href="${issue.web_url}" target="_blank">${escapeHtml(issue.title)}</a></div>
                                <div style="font-size: 0.85em; color: #7f8c8d; margin-top: 3px;">
                                    ${issue.state}
                                    ${issue.labels.length > 0 ? '‚Ä¢ ' + issue.labels.map(l => `<span class="label-tag">${l}</span>`).join('') : ''}
                                </div>
                                ${link.epic ? `<div style="font-size: 0.85em; margin-top: 3px;">Epic: ${escapeHtml(link.epic.title)}</div>` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderEpics(epics) {
            return `
                <div class="detail-section">
                    <h4>Epics (${epics.length})</h4>
                    ${epics.map(epic => `
                        <div class="detail-item">
                            <div><strong>&${epic.iid}:</strong> <a href="${epic.web_url}" target="_blank">${escapeHtml(epic.title)}</a></div>
                            <div style="font-size: 0.85em; color: #7f8c8d;">${epic.state}</div>
                            ${epic.description ? `<div style="font-size: 0.85em; margin-top: 5px;">${escapeHtml(epic.description.substring(0, 150))}${epic.description.length > 150 ? '...' : ''}</div>` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function displayError(message) {
            document.getElementById('results').innerHTML = `
                <div class="error">
                    <strong>Error:</strong> ${escapeHtml(message)}
                </div>
            `;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function generateUpdates(commitId) {
            const contentDiv = document.getElementById(`updates-content-${commitId}`);
            const button = event.target;

            // Find the chain for this commit
            if (!currentTraceData || !currentTraceData.chains) {
                alert('No trace data available. Please trace a commit first.');
                return;
            }

            const chain = currentTraceData.chains.find(c => c.commit.id === commitId);
            if (!chain) {
                alert('Commit not found in trace data');
                return;
            }

            // Show loading
            button.disabled = true;
            button.textContent = 'Generating...';
            contentDiv.innerHTML = `
                <div class="updates-loading">
                    <div class="spinner"></div>
                    <p>Generating stakeholder updates with AI...</p>
                    <p style="font-size: 0.85em; margin-top: 5px;">This may take 5-10 seconds</p>
                </div>
            `;

            try {
                const response = await fetch(`${API_BASE}/analyze/updates`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chain })
                });

                if (!response.ok) {
                    throw new Error(await response.text());
                }

                const result = await response.json();
                displayUpdates(commitId, result);
                button.textContent = '‚úì Updates Generated';
                button.style.background = '#6c757d';
            } catch (error) {
                contentDiv.innerHTML = `
                    <div class="error">
                        <strong>Failed to generate updates:</strong> ${escapeHtml(error.message)}
                    </div>
                `;
                button.disabled = false;
                button.textContent = 'Retry';
            }
        }

        function extractTeamFromLabels(labels) {
            if (!labels || !Array.isArray(labels)) return null;
            const teamLabel = labels.find(l => l.toLowerCase().startsWith('team:'));
            if (teamLabel) {
                return teamLabel.substring(5); // Remove "team:" prefix
            }
            return null;
        }

        function getProjectContext(chain) {
            let epicName = null;
            let team = null;

            // Try to get epic from issue links
            if (chain.issues && chain.issues.length > 0) {
                for (const issueLink of chain.issues) {
                    if (issueLink.epic) {
                        epicName = issueLink.epic.title;
                    }
                    if (issueLink.issue && issueLink.issue.labels) {
                        const foundTeam = extractTeamFromLabels(issueLink.issue.labels);
                        if (foundTeam) {
                            team = foundTeam;
                        }
                    }
                }
            }

            // Fallback to epics array
            if (!epicName && chain.epics && chain.epics.length > 0) {
                epicName = chain.epics[0].title;
            }

            return { epicName, team };
        }

        function displayUpdates(commitId, data) {
            const contentDiv = document.getElementById(`updates-content-${commitId}`);
            const context = getProjectContext(data.chain);

            // Build context header
            let contextHeader = '';
            if (context.epicName || context.team) {
                contextHeader = '<div style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin-bottom: 15px; font-size: 0.9em;">';
                if (context.epicName) {
                    contextHeader += `<div><strong>Project/Epic:</strong> ${escapeHtml(context.epicName)}</div>`;
                }
                if (context.team) {
                    contextHeader += `<div style="margin-top: 5px;"><strong>Team:</strong> ${escapeHtml(context.team)}</div>`;
                }
                contextHeader += '</div>';
            }

            const html = `
                ${contextHeader}
                <div class="update-box technical">
                    <div class="update-box-header">
                        <span class="icon">üìã</span>
                        <span>Technical Update</span>
                        <span style="font-size: 0.85em; font-weight: normal; color: #7f8c8d;">
                            (For: CPO, Product Leaders, Developers, PMs, Architects)
                        </span>
                        <button class="copy-btn" onclick="copyToClipboard('tech-${commitId}', this)">
                            Copy
                        </button>
                    </div>
                    <div class="update-box-content" id="tech-${commitId}">
                        ${escapeHtml(data.updates.technicalUpdate)}
                    </div>
                </div>

                <div class="update-box business">
                    <div class="update-box-header">
                        <span class="icon">üíº</span>
                        <span>Business Update</span>
                        <span style="font-size: 0.85em; font-weight: normal; color: #7f8c8d;">
                            (For: Marketing, Sales, Support, GTM, Executives)
                        </span>
                        <button class="copy-btn" onclick="copyToClipboard('biz-${commitId}', this)">
                            Copy
                        </button>
                    </div>
                    <div class="update-box-content" id="biz-${commitId}">
                        ${escapeHtml(data.updates.businessUpdate)}
                    </div>
                </div>

                ${data.updates.metadata ? `
                    <div class="update-meta">
                        <strong>Generation Details:</strong>
                        Model: ${data.updates.metadata.model} ‚Ä¢
                        Duration: ${data.updates.metadata.durationMs}ms ‚Ä¢
                        Tokens: ${data.updates.metadata.tokensUsed || 'N/A'} ‚Ä¢
                        Cost: $${data.updates.metadata.costUsd?.toFixed(4) || 'N/A'}
                    </div>
                ` : ''}

                ${data.analysis ? `
                    <div class="update-meta" style="margin-top: 10px; padding-top: 10px;">
                        <strong>Analysis Context:</strong>
                        Reason: ${escapeHtml(data.analysis.reason.substring(0, 100))}... ‚Ä¢
                        Alignment: ${data.analysis.alignment} ‚Ä¢
                        Confidence: ${(data.analysis.confidence * 100).toFixed(0)}%
                    </div>
                ` : ''}
            `;

            contentDiv.innerHTML = html;
        }

        async function copyToClipboard(elementId, button) {
            const element = document.getElementById(elementId);
            const text = element.textContent;

            try {
                await navigator.clipboard.writeText(text);
                const originalText = button.textContent;
                button.textContent = '‚úì Copied!';
                button.style.background = '#d4edda';
                button.style.color = '#155724';

                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '';
                    button.style.color = '';
                }, 2000);
            } catch (error) {
                alert('Failed to copy to clipboard');
            }
        }

        // =====================================================================
        // Monitoring Functions
        // =====================================================================

        // Refresh monitor status on load
        window.addEventListener('load', () => {
            refreshMonitorStatus();
            refreshMonitoredCommits();
            // Auto-refresh every 30 seconds
            setInterval(refreshMonitorStatus, 30000);
            setInterval(refreshMonitoredCommits, 30000);
        });

        async function startMonitoring() {
            const button = document.getElementById('startMonitorBtn');
            button.disabled = true;
            button.textContent = '‚è≥ Starting...';

            try {
                const response = await fetch(`${API_BASE}/monitor/start`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok) {
                    alert('‚úÖ Monitoring started! The system will now automatically detect new commits.');
                    await refreshMonitorStatus();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Failed to start monitoring: ' + error.message);
            } finally {
                button.disabled = false;
                button.textContent = '‚ñ∂Ô∏è Start';
            }
        }

        async function stopMonitoring() {
            const button = document.getElementById('stopMonitorBtn');
            button.disabled = true;
            button.textContent = '‚è≥ Stopping...';

            try {
                const response = await fetch(`${API_BASE}/monitor/stop`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok) {
                    alert('‚è∏Ô∏è Monitoring stopped.');
                    await refreshMonitorStatus();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Failed to stop monitoring: ' + error.message);
            } finally {
                button.disabled = false;
                button.textContent = '‚è∏Ô∏è Stop';
            }
        }

        async function pollNow() {
            const button = document.getElementById('pollNowBtn');
            button.disabled = true;
            button.textContent = '‚è≥ Polling...';

            try {
                // Get the list of monitored projects
                const projectsResponse = await fetch(`${API_BASE}/monitor/projects`);
                const projectsData = await projectsResponse.json();

                if (!projectsData.projects || projectsData.projects.length === 0) {
                    alert('No projects configured. Please edit config/projects.json');
                    return;
                }

                const enabledProjects = projectsData.projects.filter(p => p.enabled);

                if (enabledProjects.length === 0) {
                    alert('No enabled projects. Please enable at least one project in config/projects.json');
                    return;
                }

                // Poll each enabled project
                let successCount = 0;
                let errorCount = 0;

                for (const project of enabledProjects) {
                    try {
                        const response = await fetch(`${API_BASE}/monitor/poll/${project.id}`, {
                            method: 'POST'
                        });

                        if (response.ok) {
                            successCount++;
                        } else {
                            errorCount++;
                        }
                    } catch (error) {
                        errorCount++;
                        console.error(`Failed to poll ${project.name}:`, error);
                    }
                }

                // Refresh the UI
                await Promise.all([
                    refreshMonitorStatus(),
                    refreshMonitoredCommits()
                ]);

                if (errorCount === 0) {
                    alert(`‚úÖ Successfully polled ${successCount} project(s)! Check the feed below for new commits.`);
                } else {
                    alert(`‚ö†Ô∏è Polled ${successCount} project(s), but ${errorCount} failed. Check console for details.`);
                }
            } catch (error) {
                alert('Failed to poll projects: ' + error.message);
            } finally {
                button.disabled = false;
                button.textContent = 'üîç Poll Now';
            }
        }

        async function refreshMonitorStatus() {
            const statusDiv = document.getElementById('monitorStatus');

            try {
                const response = await fetch(`${API_BASE}/monitor/status`);
                const data = await response.json();

                const { monitor, processor, states } = data;

                const statusHtml = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Status</div>
                            <div style="font-size: 1.2em;">
                                ${monitor.isRunning ? '‚úÖ Running' : '‚è∏Ô∏è Stopped'}
                            </div>
                        </div>
                        <div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Projects</div>
                            <div>${monitor.enabledProjects} enabled / ${monitor.totalProjects} total</div>
                        </div>
                        <div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Discovered</div>
                            <div>${monitor.totalCommitsDiscovered} commits</div>
                        </div>
                        <div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Queue</div>
                            <div>${processor.queueSize} pending (${processor.processing} processing)</div>
                        </div>
                        <div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Processed</div>
                            <div>${processor.completed} completed, ${processor.failed} failed</div>
                        </div>
                        <div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Next Poll</div>
                            <div>${monitor.nextPollAt ? new Date(monitor.nextPollAt).toLocaleTimeString() : 'N/A'}</div>
                        </div>
                    </div>
                `;

                statusDiv.innerHTML = statusHtml;
            } catch (error) {
                statusDiv.innerHTML = `<p style="margin: 0; color: #e74c3c;">Error loading status: ${error.message}</p>`;
            }
        }

        async function refreshMonitoredCommits() {
            const commitsDiv = document.getElementById('monitoredCommits');

            try {
                const response = await fetch(`${API_BASE}/monitor/commits`);
                const data = await response.json();

                // Get status to show baseline info
                const statusResponse = await fetch(`${API_BASE}/monitor/status`);
                const statusData = await statusResponse.json();

                if (!data.commits || data.commits.length === 0) {
                    // Show detailed message explaining why no commits are visible
                    const states = statusData.states || [];
                    let baselineInfo = '';

                    if (states.length > 0) {
                        const state = states[0];
                        if (state.lastCommitSha) {
                            baselineInfo = `
                                <div style="margin-top: 15px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
                                    <div style="font-weight: 600; margin-bottom: 10px;">‚ÑπÔ∏è Why is this empty?</div>
                                    <div style="margin-bottom: 10px;">
                                        The monitoring system is working correctly! When you first started monitoring,
                                        the system recorded the latest commit as a baseline:
                                    </div>
                                    <div style="font-family: monospace; background: white; padding: 10px; border-radius: 4px; margin-bottom: 10px;">
                                        <strong>Project:</strong> ${state.projectId}<br>
                                        <strong>Branch:</strong> ${state.branch}<br>
                                        <strong>Baseline:</strong> ${state.lastCommitSha.substring(0, 8)}<br>
                                        <strong>Last polled:</strong> ${state.lastPolledAt ? new Date(state.lastPolledAt).toLocaleString() : 'Never'}
                                    </div>
                                    <div style="margin-bottom: 10px;">
                                        <strong>Only commits NEWER than the baseline will appear here.</strong>
                                        If no new commits have been made since then, the feed will be empty.
                                    </div>
                                    <div>
                                        To see recent commits and reset the baseline, click the
                                        <strong>"Show Recent Commits"</strong> button above.
                                    </div>
                                </div>
                            `;
                        }
                    }

                    commitsDiv.innerHTML = `
                        <p style="text-align: center; color: #7f8c8d; margin-bottom: 10px;">
                            ${statusData.monitor?.totalCommitsDiscovered > 0
                                ? 'No new commits detected since monitoring started.'
                                : 'No monitored commits yet. Start monitoring to see new commits automatically.'}
                        </p>
                        ${baselineInfo}
                    `;
                    return;
                }

                const commitsHtml = data.commits.slice(0, 10).map(item => {
                    const commit = item.commit;
                    const chain = item.chain;
                    const hasChain = chain && chain.mergeRequests;
                    const hasUpdates = item.updates && item.updates.technicalUpdate;

                    return `
                        <div class="commit-card" style="border-left: 4px solid ${hasUpdates ? '#9b59b6' : hasChain ? '#2ecc71' : '#f39c12'}; margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div>
                                    <div style="font-weight: 600; font-size: 1.1em; margin-bottom: 5px;">
                                        ${escapeHtml(commit.title)}
                                    </div>
                                    <div style="font-size: 0.85em; color: #7f8c8d;">
                                        <a href="https://gitlab.com/${commit.projectId}/-/commit/${commit.sha}" target="_blank" style="color: #667eea;">
                                            ${commit.sha.substring(0, 8)}
                                        </a>
                                        ‚Ä¢ ${commit.authorName}
                                        ‚Ä¢ ${new Date(commit.discoveredAt).toLocaleString()}
                                    </div>
                                </div>
                                <div style="text-align: right; font-size: 0.85em;">
                                    <div style="font-weight: 600; color: ${hasUpdates ? '#9b59b6' : hasChain ? '#2ecc71' : '#f39c12'};">
                                        ${hasUpdates ? '‚ú® Updates Ready' : hasChain ? '‚úÖ Traced' : '‚è≥ Processing'}
                                    </div>
                                </div>
                            </div>

                            ${hasChain ? `
                                <div style="display: flex; gap: 15px; padding: 10px; background: rgba(0,0,0,0.05); border-radius: 6px; font-size: 0.9em; margin-bottom: 10px;">
                                    <div>MRs: <strong>${chain.mergeRequests.length}</strong></div>
                                    <div>Issues: <strong>${chain.issues.length}</strong></div>
                                    <div>Epics: <strong>${chain.epics.length}</strong></div>
                                    <div>API Calls: ${chain.metadata.apiCallCount}</div>
                                    <div>Duration: ${chain.metadata.durationMs}ms</div>
                                </div>
                            ` : ''}

                            ${hasUpdates ? `
                                <div style="margin-top: 15px;">
                                    <div>
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                            <span style="font-weight: 600; color: #28a745;">üíº Business Update</span>
                                            ${item.analysis ? `<span style="font-size: 0.85em; color: #7f8c8d;">Confidence: ${(item.analysis.confidence * 100).toFixed(0)}%</span>` : ''}
                                        </div>
                                        <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; border-left: 3px solid #28a745; font-size: 0.9em; line-height: 1.5;">
                                            ${escapeHtml(item.updates.businessUpdate)}
                                        </div>
                                    </div>
                                </div>
                            ` : hasChain ? `
                                <div style="padding: 10px; background: #fff3cd; border-radius: 6px; font-size: 0.85em; color: #856404;">
                                    ü§ñ AI analysis in progress... Updates will appear here shortly.
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');

                commitsDiv.innerHTML = `
                    <div style="margin-bottom: 10px; color: #7f8c8d; font-size: 0.9em;">
                        Showing ${Math.min(10, data.commits.length)} of ${data.total} monitored commits
                    </div>
                    ${commitsHtml}
                `;
            } catch (error) {
                commitsDiv.innerHTML = `<p style="text-align: center; color: #e74c3c;">Error loading commits: ${error.message}</p>`;
            }
        }

        async function showRecentCommits() {
            const button = document.getElementById('showRecentBtn');
            button.disabled = true;
            button.textContent = '‚è≥ Loading...';

            try {
                // Get the list of monitored projects
                const projectsResponse = await fetch(`${API_BASE}/monitor/projects`);
                const projectsData = await projectsResponse.json();

                if (!projectsData.projects || projectsData.projects.length === 0) {
                    alert('No projects configured. Please edit config/projects.json');
                    return;
                }

                const enabledProjects = projectsData.projects.filter(p => p.enabled);

                if (enabledProjects.length === 0) {
                    alert('No enabled projects. Please enable at least one project in config/projects.json');
                    return;
                }

                // For each enabled project, get recent commits and reset baseline
                const response = await fetch(`${API_BASE}/monitor/show-recent`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ count: 5 })
                });

                const data = await response.json();

                if (response.ok) {
                    // Refresh the UI
                    await Promise.all([
                        refreshMonitorStatus(),
                        refreshMonitoredCommits()
                    ]);

                    alert(`‚úÖ Loaded ${data.totalCommits} recent commit(s) and reset baseline! These commits will now be traced and appear in the feed below.`);
                } else {
                    alert('Error: ' + (data.error || 'Failed to load recent commits'));
                }
            } catch (error) {
                alert('Failed to load recent commits: ' + error.message);
            } finally {
                button.disabled = false;
                button.textContent = 'üìã Show Recent Commits';
            }
        }

        // =====================================================================
        // Merge Requests List Functions
        // =====================================================================

        // MR List state
        let mrListState = {
            currentPage: 1,
            pageSize: 20,
            filterState: 'all',
            totalPages: 1,
            allMRs: [],
            filteredMRs: [],
        };

        // Load MRs on page load
        window.addEventListener('load', loadMRList);

        async function loadMRList() {
            const contentDiv = document.getElementById('mrListContent');

            try {
                contentDiv.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading merge requests from database...</p>
                    </div>
                `;

                // Fetch MRs from database (supports unlimited via pagination)
                const response = await fetch(`${API_BASE}/merge-requests/db?limit=1000&state=all`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                mrListState.allMRs = data.mergeRequests || [];
                mrListState.filteredMRs = mrListState.allMRs;

                // Show message if database is empty
                if (mrListState.allMRs.length === 0) {
                    contentDiv.innerHTML = `
                        <div style="padding: 60px 20px; text-align: center;">
                            <div style="font-size: 3em; margin-bottom: 15px;">üì¶</div>
                            <h3 style="color: #7f8c8d; margin-bottom: 10px;">No merge requests in database</h3>
                            <p style="color: #95a5a6; margin-bottom: 20px;">Click "Sync from GitLab" to fetch and store merge requests from your GitLab project.</p>
                            <button onclick="syncMRsFromGitLab()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                üîÑ Sync from GitLab
                            </button>
                        </div>
                    `;
                    return;
                }

                renderMRList();
            } catch (error) {
                console.error('Failed to load MRs:', error);
                contentDiv.innerHTML = `
                    <div style="padding: 60px 20px; text-align: center;">
                        <div style="font-size: 3em; margin-bottom: 15px;">‚ö†Ô∏è</div>
                        <h3 style="color: #e74c3c; margin-bottom: 10px;">Failed to load merge requests</h3>
                        <p style="color: #7f8c8d; margin-bottom: 20px;">${escapeHtml(error.message)}</p>
                        <button onclick="loadMRList()" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                            üîÑ Retry
                        </button>
                    </div>
                `;
            }
        }

        async function syncMRsFromGitLab() {
            const button = event.target;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = '‚è≥ Syncing...';

            try {
                const response = await fetch(`${API_BASE}/merge-requests/sync`, {
                    method: 'POST',
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                // Show success message
                alert(`‚úÖ Successfully synced ${result.synced} merge requests from GitLab!`);

                // Reload the list
                await loadMRList();
            } catch (error) {
                console.error('Failed to sync MRs:', error);
                alert(`‚ùå Failed to sync merge requests: ${error.message}`);
            } finally {
                button.disabled = false;
                button.textContent = originalText;
            }
        }

        function filterMRs(state) {
            mrListState.filterState = state;
            mrListState.currentPage = 1;

            // Update filter button states
            document.querySelectorAll('.filter-btn-group button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Apply filter
            if (state === 'all') {
                mrListState.filteredMRs = mrListState.allMRs;
            } else {
                mrListState.filteredMRs = mrListState.allMRs.filter(mr => mr.state === state);
            }

            renderMRList();
        }

        function renderMRList() {
            const contentDiv = document.getElementById('mrListContent');
            const paginationControls = document.getElementById('mrPaginationControls');

            if (mrListState.filteredMRs.length === 0) {
                const stateText = mrListState.filterState === 'all'
                    ? 'merge requests'
                    : `${mrListState.filterState} merge requests`;

                contentDiv.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <div style="font-size: 3em; margin-bottom: 15px;">üîÄ</div>
                        <h3 style="color: #7f8c8d; margin-bottom: 10px;">No ${stateText} found</h3>
                        <p style="color: #95a5a6;">
                            ${mrListState.filterState === 'all'
                                ? 'There are no merge requests in this project yet.'
                                : `Try selecting a different filter or create a new merge request.`}
                        </p>
                    </div>
                `;
                paginationControls.style.display = 'none';
                return;
            }

            // Calculate pagination
            const startIndex = (mrListState.currentPage - 1) * mrListState.pageSize;
            const endIndex = startIndex + mrListState.pageSize;
            const paginatedMRs = mrListState.filteredMRs.slice(startIndex, endIndex);
            mrListState.totalPages = Math.ceil(mrListState.filteredMRs.length / mrListState.pageSize);

            // Render MR cards
            const mrHtml = paginatedMRs.map(mr => {
                const createdDate = new Date(mr.createdAt || mr.created_at);
                const updatedDate = new Date(mr.updatedAt || mr.updated_at);
                const mergedAt = mr.mergedAt || mr.merged_at;
                const webUrl = mr.webUrl || mr.web_url;
                const sourceBranch = mr.sourceBranch || mr.source_branch;
                const targetBranch = mr.targetBranch || mr.target_branch;
                const authorName = mr.authorName || mr.author?.name || 'Unknown';
                const labels = mr.labels || [];
                const upvotes = mr.upvotes !== undefined ? mr.upvotes : (mr.upvotes !== undefined ? mr.upvotes : 0);
                const downvotes = mr.downvotes !== undefined ? mr.downvotes : (mr.downvotes !== undefined ? mr.downvotes : 0);
                const userNotesCount = mr.userNotesCount || mr.user_notes_count || 0;

                return `
                    <div class="mr-card ${mr.state}">
                        <div class="mr-card-header">
                            <div style="flex: 1;">
                                <div class="mr-title">
                                    <a href="${webUrl}" target="_blank" style="color: #2c3e50; text-decoration: none;">
                                        !${mr.iid}: ${escapeHtml(mr.title)}
                                    </a>
                                </div>
                                <div class="mr-meta">
                                    <a href="${webUrl}" target="_blank">!${mr.iid}</a>
                                    ‚Ä¢ ${escapeHtml(authorName)}
                                    ‚Ä¢ Created ${createdDate.toLocaleDateString()}
                                    ${mergedAt ? `‚Ä¢ Merged ${new Date(mergedAt).toLocaleDateString()}` : ''}
                                </div>
                            </div>
                            <div>
                                <span class="mr-state-badge ${mr.state}">
                                    ${mr.state === 'merged' ? 'üü£ Merged' : mr.state === 'opened' ? 'üü¢ Open' : 'üî¥ Closed'}
                                </span>
                            </div>
                        </div>

                        ${mr.description ? `
                            <div style="margin-top: 10px; font-size: 0.9em; color: #7f8c8d; line-height: 1.5;">
                                ${escapeHtml(mr.description.substring(0, 200))}${mr.description.length > 200 ? '...' : ''}
                            </div>
                        ` : ''}

                        <div class="mr-stats">
                            ${sourceBranch ? `<div><strong>Source:</strong> ${escapeHtml(sourceBranch)}</div>` : ''}
                            ${targetBranch ? `<div><strong>Target:</strong> ${escapeHtml(targetBranch)}</div>` : ''}
                            <div>üëç ${upvotes}</div>
                            <div>üëé ${downvotes}</div>
                            <div>üí¨ ${userNotesCount} comments</div>
                            <div>Updated ${updatedDate.toLocaleDateString()}</div>
                        </div>

                        ${labels && labels.length > 0 ? `
                            <div style="margin-top: 10px;">
                                ${labels.map(label => `<span class="label-tag">${escapeHtml(label)}</span>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            contentDiv.innerHTML = `
                <div style="margin-bottom: 15px; color: #7f8c8d; font-size: 0.9em;">
                    Showing ${startIndex + 1}-${Math.min(endIndex, mrListState.filteredMRs.length)} of ${mrListState.filteredMRs.length} merge requests
                </div>
                ${mrHtml}
            `;

            // Update pagination controls
            updateMRPaginationControls();
            paginationControls.style.display = 'flex';
        }

        function updateMRPaginationControls() {
            const paginationInfo = document.getElementById('mrPaginationInfo');
            const firstBtn = document.getElementById('mrFirstBtn');
            const prevBtn = document.getElementById('mrPrevBtn');
            const nextBtn = document.getElementById('mrNextBtn');
            const lastBtn = document.getElementById('mrLastBtn');

            paginationInfo.textContent = `Page ${mrListState.currentPage} of ${mrListState.totalPages}`;

            // Disable/enable buttons based on current page
            firstBtn.disabled = mrListState.currentPage === 1;
            prevBtn.disabled = mrListState.currentPage === 1;
            nextBtn.disabled = mrListState.currentPage === mrListState.totalPages;
            lastBtn.disabled = mrListState.currentPage === mrListState.totalPages;
        }

        function goToMRPage(direction) {
            switch (direction) {
                case 'first':
                    mrListState.currentPage = 1;
                    break;
                case 'prev':
                    if (mrListState.currentPage > 1) {
                        mrListState.currentPage--;
                    }
                    break;
                case 'next':
                    if (mrListState.currentPage < mrListState.totalPages) {
                        mrListState.currentPage++;
                    }
                    break;
                case 'last':
                    mrListState.currentPage = mrListState.totalPages;
                    break;
            }

            renderMRList();

            // Scroll to top of MR list
            document.querySelector('.mr-list-section').scrollIntoView({ behavior: 'smooth' });
        }

        function changeMRPageSize() {
            const select = document.getElementById('mrPageSize');
            mrListState.pageSize = parseInt(select.value);
            mrListState.currentPage = 1; // Reset to first page
            renderMRList();
        }

        function refreshMRList() {
            loadMRList();
        }

        function toggleMRSection(button) {
            const content = document.getElementById('mrCollapsibleContent');
            const isExpanded = content.classList.contains('expanded');

            if (isExpanded) {
                content.classList.remove('expanded');
                button.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                button.classList.add('expanded');
            }
        }

        // =====================================================================
        // Recent Commits List Functions
        // =====================================================================

        // Commits List state
        let commitsListState = {
            currentPage: 1,
            pageSize: 10,
            totalPages: 1,
            allCommits: [],
        };

        // Load commits on page load
        window.addEventListener('load', loadCommitsList);

        async function loadCommitsList() {
            const contentDiv = document.getElementById('commitsListContent');

            try {
                contentDiv.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading recent commits from database...</p>
                    </div>
                `;

                // Fetch commits from database
                const response = await fetch(`${API_BASE}/commits/db/recent?limit=100&offset=0`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                commitsListState.allCommits = data.commits || [];

                // Show message if database is empty
                if (commitsListState.allCommits.length === 0) {
                    contentDiv.innerHTML = `
                        <div style="padding: 60px 20px; text-align: center;">
                            <div style="font-size: 3em; margin-bottom: 15px;">üì¶</div>
                            <h3 style="color: #7f8c8d; margin-bottom: 10px;">No commits in database yet</h3>
                            <p style="color: #95a5a6; margin-bottom: 20px;">
                                Trace commits using the controls above to build your commit history.
                            </p>
                        </div>
                    `;
                    return;
                }

                renderCommitsList();
            } catch (error) {
                console.error('Failed to load commits:', error);
                contentDiv.innerHTML = `
                    <div style="padding: 60px 20px; text-align: center;">
                        <div style="font-size: 3em; margin-bottom: 15px;">‚ö†Ô∏è</div>
                        <h3 style="color: #e74c3c; margin-bottom: 10px;">Failed to load commits</h3>
                        <p style="color: #7f8c8d; margin-bottom: 20px;">${escapeHtml(error.message)}</p>
                        <button onclick="loadCommitsList()" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                            üîÑ Retry
                        </button>
                    </div>
                `;
            }
        }

        function renderCommitsList() {
            const contentDiv = document.getElementById('commitsListContent');
            const paginationControls = document.getElementById('commitsPaginationControls');

            if (commitsListState.allCommits.length === 0) {
                contentDiv.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <div style="font-size: 3em; margin-bottom: 15px;">üì¶</div>
                        <h3 style="color: #7f8c8d; margin-bottom: 10px;">No commits found</h3>
                        <p style="color: #95a5a6;">
                            Trace commits using the controls above to build your commit history.
                        </p>
                    </div>
                `;
                paginationControls.style.display = 'none';
                return;
            }

            // Calculate pagination
            const startIndex = (commitsListState.currentPage - 1) * commitsListState.pageSize;
            const endIndex = startIndex + commitsListState.pageSize;
            const paginatedCommits = commitsListState.allCommits.slice(startIndex, endIndex);
            commitsListState.totalPages = Math.ceil(commitsListState.allCommits.length / commitsListState.pageSize);

            // Render commit cards
            const commitsHtml = paginatedCommits.map(commit => {
                const authoredDate = new Date(commit.authoredDate || commit.authored_date);
                const committedDate = new Date(commit.committedDate || commit.committed_date);
                const webUrl = commit.webUrl || commit.web_url;
                const authorName = commit.authorName || commit.author_name || 'Unknown';
                const authorEmail = commit.authorEmail || commit.author_email || '';
                const shortId = commit.shortId || commit.short_id || commit.sha.substring(0, 8);

                return `
                    <div class="mr-card">
                        <div class="mr-card-header">
                            <div style="flex: 1;">
                                <div class="mr-title">
                                    <a href="${webUrl}" target="_blank" style="color: #2c3e50; text-decoration: none;">
                                        ${escapeHtml(commit.title)}
                                    </a>
                                </div>
                                <div class="mr-meta">
                                    <code>${shortId}</code>
                                    ‚Ä¢ ${escapeHtml(authorName)}
                                    ${authorEmail ? `<${escapeHtml(authorEmail)}>` : ''}
                                    ‚Ä¢ Authored ${authoredDate.toLocaleDateString()} ${authoredDate.toLocaleTimeString()}
                                </div>
                            </div>
                            <div>
                                <button onclick="loadCommitTrace('${commit.sha}')" style="background: #667eea; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                                    üîç View Trace
                                </button>
                            </div>
                        </div>

                        ${commit.message ? `
                            <div style="margin-top: 10px; font-size: 0.9em; color: #7f8c8d; line-height: 1.5; white-space: pre-wrap;">
                                ${escapeHtml(commit.message.substring(0, 300))}${commit.message.length > 300 ? '...' : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            contentDiv.innerHTML = `
                <div style="margin-bottom: 15px; color: #7f8c8d; font-size: 0.9em;">
                    Showing ${startIndex + 1}-${Math.min(endIndex, commitsListState.allCommits.length)} of ${commitsListState.allCommits.length} commits
                </div>
                ${commitsHtml}
            `;

            // Update pagination controls
            updateCommitsPaginationControls();
            paginationControls.style.display = 'flex';
        }

        function updateCommitsPaginationControls() {
            const paginationInfo = document.getElementById('commitsPaginationInfo');
            const firstBtn = document.getElementById('commitsFirstBtn');
            const prevBtn = document.getElementById('commitsPrevBtn');
            const nextBtn = document.getElementById('commitsNextBtn');
            const lastBtn = document.getElementById('commitsLastBtn');

            paginationInfo.textContent = `Page ${commitsListState.currentPage} of ${commitsListState.totalPages}`;

            // Disable/enable buttons based on current page
            firstBtn.disabled = commitsListState.currentPage === 1;
            prevBtn.disabled = commitsListState.currentPage === 1;
            nextBtn.disabled = commitsListState.currentPage === commitsListState.totalPages;
            lastBtn.disabled = commitsListState.currentPage === commitsListState.totalPages;
        }

        function goToCommitsPage(direction) {
            switch (direction) {
                case 'first':
                    commitsListState.currentPage = 1;
                    break;
                case 'prev':
                    if (commitsListState.currentPage > 1) {
                        commitsListState.currentPage--;
                    }
                    break;
                case 'next':
                    if (commitsListState.currentPage < commitsListState.totalPages) {
                        commitsListState.currentPage++;
                    }
                    break;
                case 'last':
                    commitsListState.currentPage = commitsListState.totalPages;
                    break;
            }

            renderCommitsList();

            // Scroll to top of commits list
            document.getElementById('commitsCollapsibleContent').scrollIntoView({ behavior: 'smooth' });
        }

        function changeCommitsPageSize() {
            const select = document.getElementById('commitsPageSize');
            commitsListState.pageSize = parseInt(select.value);
            commitsListState.currentPage = 1; // Reset to first page
            renderCommitsList();
        }

        function refreshCommitsList() {
            loadCommitsList();
        }

        function toggleCommitsSection(button) {
            const content = document.getElementById('commitsCollapsibleContent');
            const isExpanded = content.classList.contains('expanded');

            if (isExpanded) {
                content.classList.remove('expanded');
                button.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                button.classList.add('expanded');
            }
        }

        async function loadCommitTrace(sha) {
            // Scroll to results section
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });

            // Load the trace for this commit
            try {
                const response = await fetch(`${API_BASE}/trace/commit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sha, forceRefresh: false })
                });

                if (!response.ok) {
                    throw new Error(await response.text());
                }

                const chain = await response.json();
                currentTraceData = { chains: [chain], summary: null };
                renderTraceResults();
            } catch (error) {
                alert('Failed to load commit trace: ' + error.message);
            }
        }
    </script>

    <!-- Authentication Helper (Feature-Flagged) -->
    <script src="/auth-helper.js"></script>
</body>
</html>
